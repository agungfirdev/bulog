<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Banpang - 2024</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Option 1: Include in HTML -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />
    <style>
      /* Option 2: Import via CSS */
      @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css");
      * {
        box-sizing: border-box;
      }

      /* .zoom-move {
        transition: transform 0.5s;
        cursor: pointer;
      }

      .zoom-move:hover {
        transform: scale(1.2) translate(10px, 10px);
      } */

      .dot {
        width: 15px;
        height: 15px;
        display: block;
        border-radius: 50%;
      }

      /* .table-responsive {
        overflow-x: auto;
      }

      .table-responsive table {
        border-collapse: collapse;
        width: 100%;
      }

      .table-responsive th:first-child,
      .table-responsive td:first-child {
        position: sticky;
        left: 0;
        background-color: #fff;
        z-index: 10;
      } */

      .toast {
        display: none; /* Hidden by default */
        position: fixed; /* Sit on top of the screen */
        top: 0;
        left: 0;
        margin: 0 !important;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        background-color: rgba(
          0,
          0,
          0,
          0.5
        ); /* Black background with 50% opacity */
        color: white; /* Text color */
        align-items: center; /* Center content vertically */
        justify-content: center; /* Center content horizontally */
        flex-direction: column; /* Stack items vertically */
        z-index: 1000; /* Stay on top */
        animation: fadeIn 0.5s, fadeOut 0.5s 4.5s; /* Fade in and out */
        display: flex; /* Use flexbox for centering */
      }

      .toast-image {
        width: 200px;
        max-width: 20%; /* Adjust image size */
        border-radius: 10px; /* Rounded corners */
        margin-bottom: 20px; /* Space between image and text */
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col"></div>
        <div class="col">
          <div class="d-flex justify-content-end">
            <button class="my-2 btn btn-sm btn-primary" id="export-table">
              Export
            </button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12 col-md-6">
          <div class="form-group">
            <label for="select-kecamatan">Kecamatan</label>
            <select class="form-control" id="select-kecamatan" disabled="">
              <option>Pilih Kecamatan</option>
            </select>
          </div>
        </div>
        <div class="col-sm-12 col-md-6">
          <div class="form-group">
            <label for="select-desa">Desa</label>
            <select class="form-control" id="select-desa" disabled=""></select>
          </div>
        </div>
      </div>
      <div class="mt-2 row">
        <div class="d-flex justify-content-between col-12 col-sm-8 col-md-6">
          <div>
            <span class="badge rounded-pill bg-info" id="jumlah-pbp"
              >JUMLAH</span
            >
            <span class="badge rounded-pill bg-dark" id="jumlah-awal"
              >AWAL</span
            >
            <span class="badge rounded-pill bg-success" id="jumlah-pengganti"
              >PENGGANTI</span
            >
            <span class="badge rounded-pill bg-primary" id="jumlah-perwakilan"
              >PERWAKILAN</span
            >
            <span class="badge rounded-pill bg-secondary" id="jumlah-1kk"
              >1KK</span
            >
            <span class="badge rounded-pill bg-danger" id="jumlah-sisa"
              >SISA</span
            >
          </div>
        </div>
        <div class="col-12 col-sm-4 col-md-6">
          <div class="d-inline d-sm-flex justify-content-end">
            <div class="form-check form-switch mt-2">
              <input
                class="form-check-input"
                type="checkbox"
                value=""
                id="check-open-foto-all"
              />
              <label class="form-check-label" for="check-open-foto-all">
                Buka foto
              </label>
            </div>
          </div>
        </div>
      </div>

      <div id="toast" class="toast">
        <img
          src="https://www.bulog.co.id/wp-content/uploads/2025/01/Logo-BULOG_Web.png"
          alt="Image"
          class="toast-image"
        />
      </div>

      <div id="toast-loading" class="toast row">
        <lottie-player
          src="./lottie/loading.json"
          background="transparent"
          speed="1"
          style="width: 10px; height: 10px"
          loop=""
          autoplay=""
        ></lottie-player>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <table
          class="table table-hover mt-4 table-responsive d-none table-sm"
          id="table-main"
        >
          <thead>
            <tr>
              <th scope="col sticky-left" style="width: 3%">#</th>
              <th scope="col">NO PBP</th>
              <th scope="col">NAMA AWAL</th>
              <th scope="col">NIK AWAL</th>
              <th scope="col">NAMA PENERIMA</th>
              <th scope="col">NIK PENERIMA</th>
              <th scope="col">PEKERJAAN</th>
              <th scope="col" id="header-status">
                Alasan <i class="bi bi-sort-up"></i>
              </th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="//cdn.datatables.net/2.1.5/js/dataTables.min.js"></script>
    <script>
      const onMouseOver = (target) => {
        target.style.transition = "transform 0.3s";
        target.style.transform = "scale(2)";
      };

      const onMouseOut = (target) => {
        target.style.transform = "scale(1.25)";
        target.style.transformOrigin = "center center";
      };

      const onMouseMove = (event) => {
        const target = event.currentTarget;
        const rect = target.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        const percentX = (x / rect.width) * 100;
        const percentY = (y / rect.height) * 100;
        target.style.transformOrigin = `${percentX}% ${percentY}%`;
      };

      let rotation = 0;
      function rotateImage(id) {
        rotation += 90; // Increase rotation by 90 degrees
        console.log(rotation);
        $("#" + $(id).attr("id")).css({
          "-webkit-transform": "rotate(" + rotation + "deg)",
          "-moz-transform": "rotate(" + rotation + "deg)",
          transform: "rotate(" + rotation + "deg)",
        });
      }

      function showPbp(PBPS) {
        let filterPbps = null;
        if (filterType === null) {
          filterPbps = PBPS;
        } else if (filterType === "belum diserahkan") {
          filterPbps = PBPS.filter((pbp) => pbp.foto_ktp === null);
        } else if (filterType === "1kk") {
          filterPbps = PBPS.filter(
            (pbp) => pbp.status_pbp === "normal" && pbp.nama_pengganti !== null
          );
        } else if (filterType === "awal") {
          filterPbps = PBPS.filter(
            (pbp) => pbp.status_pbp === "normal" && pbp.nama_pengganti === null
          );
        } else {
          filterPbps = PBPS.filter((pbp) => pbp.status_pbp === filterType);
        }

        let jumlahPengganti = PBPS.filter(
          (pbp) => pbp.status_pbp === "pengganti"
        ).length;
        let jumlahPerwakilan = PBPS.filter(
          (pbp) => pbp.status_pbp === "perwakilan"
        ).length;
        let jumlahSisa = PBPS.filter((pbp) => pbp.foto_ktp === null).length;
        let jumlahAwal = PBPS.filter(
          (pbp) => pbp.status_pbp === "normal" && pbp.nama_pengganti === null
        ).length;
        let jumlah1KK = PBPS.filter(
          (pbp) => pbp.status_pbp === "normal" && pbp.nama_pengganti !== null
        ).length;

        if (filterPbps.length !== 0) {
          filterPbps.forEach(
            (
              {
                no_urut_dtt,
                no_pbp,
                nik,
                nik_pengganti,
                nama,
                nama_pengganti,
                status_pbp,
                nama_kabkota,
                nama_kecamatan,
                nama_kelurahan,
                foto_pbp,
                foto_ktp,
                notes,
                alamat_pbp,
              },
              index
            ) => {
              const url = `/${nama_kabkota}/${nama_kecamatan}/${nama_kelurahan}/${no_pbp}_PBP.jpg`;

              const urlKtp = `/${nama_kabkota}/${nama_kecamatan}/${nama_kelurahan}/${no_pbp}_KTP.jpg`;

              let TEXT_STATUS = "";

              if (status_pbp === "pengganti") {
                let alasan = "";
                if (notes === "Tidak ditemukan alamatnya") {
                  alasan = "Alamat tidak ditemukan";
                } else if (
                  notes ===
                  "Tidak memenuhi syarat sebagai PBP ( Sudah Mampu/ASN/TNI/POLRI/Perangkat Daerah)"
                ) {
                  alasan = "Tidak memenuhi syarat";
                } else if (
                  notes ===
                  "PBP tidak mengambil dalam batas waktu paling lambat 5 hari kerja"
                ) {
                  alasan = "Tidak Mengambil dalam 5 hari";
                } else if (notes === "Tidak ditemukan pada alamat terdata") {
                  alasan = "Alamat tidak ditemukan";
                } else if (notes === "Dicatat lebih dari 1 kali") {
                  alasan = "Data Ganda";
                } else if (notes === null) {
                  alasan = "Berhalangan Hadir";
                } else {
                  alasan = notes;
                }
                TEXT_STATUS = `<span class="dot bg-success"></span>&nbsp;${
                  alasan !== undefined ? alasan.toUpperCase() : ""
                }`;
              } else if (status_pbp === "perwakilan") {
                TEXT_STATUS = `<span class="dot bg-primary"></span>&nbsp;PERWAKILAN`;
              } else if (foto_ktp === null) {
                TEXT_STATUS = `<span class="dot bg-danger"></span>&nbsp;BELUM DISERAHKAN`;
              } else if (status_pbp === "normal" && nama_pengganti !== null) {
                TEXT_STATUS = `<span class="dot bg-secondary"></span>&nbsp;1KK`;
              }

              $("#table-body").append(`
                        <tr role="button" data-bs-toggle="collapse" data-bs-target="#${nik}" aria-expanded="false" aria-controls="${nik}">
                            <td scope="row">${no_urut_dtt}</td>
                            <td>${no_pbp}&nbsp;</td>
                            <td>${nama}</td>
                            <td>${nik}&nbsp;</td>
                            <td>${
                              nama_pengganti !== null
                                ? nama_pengganti.toUpperCase()
                                : ""
                            }</td>
                            <td>${
                              nik_pengganti !== null ? nik_pengganti : ""
                            }&nbsp;</td>
                            <td contenteditable>
                            </td>
                            <td class="align-middle"><div class="d-flex align-items-center">${TEXT_STATUS}</div></td>
                        </tr>
                        ${
                          status_pbp !== "-"
                            ? `<tr id="${nik}" class="exclude collapse ${
                                isShow ? "show" : ""
                              }">
                            <!--- <td class="bg-transparent"></td> --->
                            <td colspan="5">
                              <img loading="lazy" src="${url}" width="100%" id="I${nik}" class="object-fit-contain"/>
                            </td>
                            <td colspan="4" class="overflow-hidden">
                              <img loading="lazy" src="${urlKtp}" width="100%" id="K${nik}" class="zoom-move object-fit-cover" onclick="rotateImage('#K${nik}')"
                                onmouseover="onMouseOver(this)"
                                onmouseout="onMouseOut(this)"
                                onmousemove="onMouseMove(event)"
                              />
                            </td>
                            <td>
                            </td>

                        </tr>`
                            : ""
                        }

                    `);
              $("#jumlah-pbp").html("JUMLAH |  " + PBPS.length);
              $("#jumlah-awal").html("AWAL |  " + jumlahAwal);
              $("#jumlah-pengganti").html("PENGGANTI |  " + jumlahPengganti);
              $("#jumlah-perwakilan").html("PERWAKILAN |  " + jumlahPerwakilan);
              $("#jumlah-1kk").html("1KK |  " + jumlah1KK);
              $("#jumlah-sisa").html("SISA |  " + jumlahSisa);
            }
          );
        } else {
          $("#table-body").html("");
        }
      }

      $(".zoom-move").hover(
        function () {
          $(this).css("transform", "scale(1.2) translate(10px, 10px)");
        },
        function () {
          $(this).css("transform", "");
        }
      );

      const toast = document.getElementById("toast");
      toast.style.display = "flex"; // Show the toast
      function showHeader() {
        $("#table-main").removeClass("d-none");
      }

      function hideHeader() {
        $("#table-main").addClass("d-none");
      }

      setTimeout(() => {
        toast.style.display = "none"; // Hide the toast after 5 seconds
      }, 2000); // 5000 milliseconds = 5 seconds

      const loading = document.getElementById("toast-loading");
      function showloading() {
        loading.style.display = "flex";
      }

      function hideloading() {
        loading.style.display = "none";
      }

      let DESA = [];
      let PBP = [];
      let kecamatanSelected = null;
      let desaSelected = null;
      let statusSelected = 1;
      let filterPbp = [];
      let alokasi = null;
      let filterType = null;
      let alokasiSelected = null;
      let isShow = false;
      $.getJSON("wilayah", function (data) {
        showloading();
        DESA = [...data];
        // menambah element option ke id select-kecamatan dengan menghapus duplikat desa berdasarkan nama_kecamatan
        const uniqueKecamatan = [
          ...new Set(DESA.map((item) => item.nama_kecamatan)),
        ];
        uniqueKecamatan.forEach((kecamatan) => {
          $("#select-kecamatan").append(
            `<option value="${kecamatan}">${kecamatan}</option>`
          );
        });
        $("#select-kecamatan").prop("disabled", false);
        hideloading();
      });

      $("#select-kecamatan").on("change", function () {
        showPbp([]);
        statusSelected = 1;
        if (this.value !== "Pilih Kecamatan") {
          kecamatanSelected = this.value;
          $("#select-desa").prop("disabled", false);
          $("#select-desa")
            .find("option")
            .remove()
            .end()
            .append('<option value="whatever">Pilih desa..</option>');
          showSelectVillage(this.value);
        } else {
          $("#select-desa").prop("disabled", true);
          $("#select-desa")
            .find("option")
            .remove()
            .end()
            .append('<option value="whatever">Pilih dulu kecamatan..</option>')
            .val("Pilih dulu kecamatan");
          showSelectVillage("TIDAK ADA");
          showPbp([]);
        }
      });

      function showSelectVillage(kecamatan) {
        const filter = DESA.filter((desa) => desa.nama_kecamatan === kecamatan);
        filter.forEach((desa) => {
          $("#select-desa").append(
            `<option value="${desa.nama_kabkota}_${desa.nama_kecamatan}_${desa.nama_kelurahan}">${desa.nama_kelurahan}</option>`
          );
        });
      }

      $("#select-desa").on("change", function () {
        showPbp([]);
        showHeader();
        const [kota, kecamatan, desa] = this.value.split("_");
        desaSelected = DESA.find(
          (d) =>
            d.nama_kabkota === kota &&
            d.nama_kecamatan === kecamatan &&
            d.nama_kelurahan === desa
        );
        statusSelected = 1;

        if (this.value !== "Pilih desa..") {
          showloading();
          $.getJSON(
            `/recipients/${desaSelected.kode_kelurahan}`,
            function (data) {
              PBP = [...data];

              $("#select-filter-status").attr("disabled", false);
              showPbp([]);
              showPbp(PBP);
              hideloading();
            }
          );
        } else {
          showSelectVillage("TIDAK ADA");
          showPbp([]);
        }
      });

      $("#header-status").on("click", function () {
        if (statusSelected >= 5) {
          statusSelected = 1;
        } else {
          statusSelected++;
        }
        if (statusSelected === 1) {
          filterType = null;
        } else if (statusSelected === 2) {
          filterType = "1kk";
        } else if (statusSelected === 3) {
          filterType = "pengganti";
        } else if (statusSelected === 4) {
          filterType = "perwakilan";
        } else if (statusSelected === 5) {
          filterType = "belum diserahkan";
        }
        showPBP();
      });

      function showPBP() {
        showPbp([]);
        showPbp(PBP);
      }

      $("#check-open-foto-all").change(function () {
        isShow = this.checked;
        showPBP();
      });
    </script>
    <script src="//cdn.rawgit.com/rainabba/jquery-table2excel/1.1.0/dist/jquery.table2excel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/table-to-json@1.0.0/lib/jquery.tabletojson.min.js"></script>
    <script>
      function tableToJSON(table) {
        let rows = table.querySelectorAll("tr");
        let headers = [...rows[0].querySelectorAll("th")].map(
          (th) => th.innerText
        );
        let data = [];

        for (let i = 1; i < rows.length; i++) {
          let row = {};
          let cells = rows[i].querySelectorAll("td");
          headers.forEach((h, j) => (row[h] = cells[j].innerText));
          data.push(row);
        }

        return data;
      }

      function downloadJSON(json) {
        json = json.filter((item) => item["NO PBP"] !== "");
        let blob = new Blob([JSON.stringify(json, null, 2)], {
          type: "application/json",
        });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${desaSelected.nama_provinsi}_${desaSelected.nama_kabkota}_${desaSelected.nama_kecamatan}_${desaSelected.nama_kelurahan}.json`;
        link.click();
      }

      $("#export-table").click(() => {
        console.log("onclick");
        // $("#table-main").table2excel({
        //   exclude: ".exclude",
        //   filename: `${desaSelected.nama_provinsi}_${desaSelected.nama_kabkota}_${desaSelected.nama_kecamatan}_${desaSelected.nama_kelurahan}.xls`,
        //   name: "PENERIMA",
        //   preserveColors: false,
        // });
        downloadJSON($("#table-main").tableToJSON());
      });
    </script>
  </body>
</html>
